# Hotpass Web UI — Functional Implementation Playbook

> Source of truth: README.md, docs/\*\*, DESIGN_REVIEW.md, apps/web-ui/IMPLEMENTATION_SUMMARY.md (no IMPLEMENTATION_COMPLETE_WEB_UI.md in repo)

---

## 0. Pre-flight Setup

- [ ] Confirm local stack (Prefect, Marquez, Hotpass CLI) reachable or start via `docker compose -f deploy/docker/docker-compose.yml up`.
- [ ] Ensure `uv` extras match target profile (`dev orchestration enrichment geospatial compliance dashboards`).
- [ ] Snapshot current `pnpm run build`, `pnpm run lint`, Playwright baseline (if available).

---

## Stage 1 – Backend job skeleton & health checks (apps/web-ui/server/index.mjs)

- [x] Job registry + command runner wrapper (`POST /api/commands/run`, `GET /api/jobs*`).
- [x] Generic job SSE stream (`GET /api/jobs/:id/events`) with keep-alives.
- [x] Health endpoint enhanced with uptime + job telemetry.
- [ ] Smoke tests for job runner (follow-up: add Vitest suite targeting `server/job-runner.js`).

---

## Stage 2 – Import pipeline backend (apps/web-ui/server/index.mjs)

- [x] Add `/api/import` (multipart) → spawn `uv run hotpass refine` in temp workspace.
- [x] Implement job registry updates for granular events (file+stage events; future cell-level hooks can extend).
- [x] `/api/import/:id/events` wired via generic job SSE stream (ensure ≤500 ms cadence from publisher).
- [x] Persist artifacts under `dist/import/<job-id>/`.

---

## Stage 3 – Frontend import integration (operator view)

### 2.1 Replace mocks

- [x] `DatasetImportPanel` → call `/api/import`, subscribe to events, surface download links once done.
- [x] DatasetImportPanel → render live processing panel (rolling stage timeline + logs/artifacts) fed by granular SSE events.
- [x] DatasetImportPanel → show milestone progress states (Upload → Refine → Complete) with real-time badges.
- [x] DatasetImportPanel → expose detailed job insights (files, notes, artifacts, logs) while keeping simple queue view for operators.
- [x] `LiveRefinementPanel` → fetch real Prefect runs, highlight new arrivals, surface notes/data docs, retain feedback entry.
- [x] Activity feed wired to `/api/activity` (role-aware event display).
- [x] `TelemetryStrip` → surface backend job/command failures.
- [x] `PipelineActivityPanel` (replaces LiveRefinementPanel) → consume `/api/runs/recent` (React Query polling/SSE fallback), show real data-docs link.
- [x] PipelineActivityPanel → highlight newly arriving runs/logs for <=2 s (background tint + fade) to emphasise real-time work.
- [x] `AgentActivityPanel` → subscribe to `/api/activity`.
- [x] `useHILApprovals` / `ApprovalPanel` → swap to new REST endpoints.
- [x] `TelemetryStrip` → include backend job/command failures.

### 2.2 Assistant tool expansion (`src/agent/tools.ts`)

- [x] Add wrappers: `runRefine`, `runEnrich`, `runQa`, `runPlanResearch`, `runContracts`.
- [x] Return `{jobId, statusUrl, logUrl}` for UI to render.
- [x] Update chat UI to stream tool responses & link to logs/RunDetails.

### 2.3 Error handling

- [x] Create shared toast/banner system (reuse `ApiBanner` variants).
- [x] Surface inline errors for uploads, approvals, assistant failures (imports already emit banners; approvals/activity pending).

### 2.4 Smart import discovery (wizard foundation)

- [x] Ship `importsApi.profileWorkbook` (POST `/api/imports/profile`) returning typed `ImportProfile`/`SheetProfile` models.
- [x] Expose `useImportProfile` (React Query mutation) and `useStoredProfiles` (query) for DatasetImport + wizard flows.
- [x] Introduce `ImportProfilePreview` inside `DatasetImportPanel` (sheet cards, column stats, issue list, join-key badges).
- [x] Provide “Download profiling JSON” + “Attach to next run” actions (copy payload into job metadata/archive).
- [x] Persist profiles under `.hotpass/ui/import-profiles/` and promote the selected one to `dist/import/<job-id>/profile.json` when a run starts (profile.json artifact + job metadata).

---

## Stage 4 – Engineer view & log streaming

### 3.1 Dashboard (operator-first)

- [x] Create `SmartImportWizard` route (`/imports/wizard`) with stepper (Upload → Profile review → Mapping → Rule toggles → Summary).
- [x] Add `LatestRefinedWorkbookCard` + `DataQualityChip` components sourced from recent run summaries.
- [ ] Implement `LiveProcessingWidget` (current workbook, sheet count, rows processed, autofixes, errors, session timer; 200–500 ms refresh).
- [ ] Build optional `CellSpotlight` panel highlighting most recent fix (e.g. Sheet2!D14 + rule).
- [ ] Surface `PendingApprovalsPanel` (links to `RunDetails` with HIL context).
- [ ] Wire inline help anchors into HelpCenter (`helpContent.ts`).

> Dependencies: profiling API/hooks from Stage 3.4, template CRUD (Stage 3.5), persisted profile payloads (Stage 3.4).

### 3.2 RunDetails (technical depth)

- [ ] Stream live logs (SSE) with tail component.
- [ ] New events (logs, cell-fixed, validation-failed) should briefly glow (≤200 ms) and then settle to normal state.
- [ ] Provide link-back to source rule / contract when an auto-fix is displayed, so users can stay in-app (no hard context switch to docs).
- [ ] QA viewer embedded from `dist/data-docs` (iframe) & JSON summary.
- [ ] Buttons for `Re-run`, `Enrich`, `Plan research`, `Explain provenance`.
- [ ] Approval audit timeline (backend data).

### 3.3 Research & governance

- [ ] Add planner tab (form for `plan research`, results viewer).
- [ ] Contracts explorer (list YAML from `dist/contracts/` with download).
- [ ] Data Docs global page or modal (link from sidebar).

### 3.4 Power tools

- [ ] Replace “copy command” with invocation via `/api/commands/run`.
- [ ] Provide log modal with tail + download.

### 3.5 Template management & consolidation preview

- [x] Ship `/api/imports/templates` CRUD in `server/index.mjs` + storage (list/create/update/delete named templates).
- [x] Build `TemplatePicker` component (integrated with wizard scaffold) + `TemplateManagerDrawer` (create/update/delete flows).
- [x] Implement wizard `MappingStep` + `RuleToggleStep` consuming profiling defaults + template overrides.
- [x] Add `ConsolidationPreview` (master/entities/contacts/addresses tabs + download).
- [x] Provide “Export template JSON” action (writes into `dist/import/templates/<name>.json`).

---

## Stage 5 – Live refinement/approvals replacement (real data)

- [ ] Leverage `useAuth().hasRole` to toggle advanced controls.
- [ ] Persist view preference (simple vs advanced) per user.
- [ ] Ensure assistant respects role gating (tool contract filtered by role).

---

## Stage 6 – Assistant + power tool upgrades

### 5.1 Real-time updates

- [ ] Decide SSE vs polling for each panel (DatasetImport, LiveRefinement, Activity).
- [ ] Prefer SSE for one-way, high-frequency updates from import/validation pipelines (see patterns in Ably, FreeCodeCamp, and recent SSE vs WebSocket guidance).
- [ ] Fall back to polling (5–10 s) only for Prefect/Marquez endpoints that cannot stream.
- [ ] Cap live UI lists to 20–50 items to avoid reflow/jank and archive older events server-side.
- [ ] Add skeleton loaders & “last updated” capsules (per DESIGN_REVIEW).

### 5.2 Error banners & transparency

- [ ] Propagate Prefect/Marquez outage info to Dashboard header.
- [ ] Warn when Admin endpoints point to private VPC (per Stage 7 requirement).

### 5.3 Accessibility & responsiveness

- [ ] Validate focus outlines, keyboard flow, screen reader labels.
- [ ] Ensure tables degrade gracefully <1024px (horizontal scroll hints/cards).

### 5.4 Engagement & microinteractions

- [ ] Upload dropzone: on drop → scale to 1.02 and swap to parsing state; on success → morph into summary card (sheet count, rows, timestamp).
- [ ] Buttons that trigger long-running jobs should show in-button progress (spinner + "Working…") for first 1–2 s and then hand over to the live processing panel. Avoid only-global toasts.
- [ ] Activity feed entries should be timestamped in SAST (UTC+2) and badge for 3 s when new.
- [ ] All animations ≤200 ms; no opacity-only animations—combine slight translate to convey direction.

### 5.5 Template-aware assistant actions

- [ ] Allow assistant to list/import templates and trigger runs with `--import-template`.
- [ ] Surface profiling summaries and outstanding issues inside chat responses.
- [ ] Provide “dry-run” / “preview fixes” assistant command before executing imports.

---

## Stage 7 – Research & governance surfaces

- [ ] Unit: job state machine, API clients, assistant tools, HIL mutations (Vitest).
- [ ] E2E: Playwright scenarios (ingest→completion, approvals workflow, assistant run trigger, Data Docs viewer).
- [ ] Storybook: new states for DatasetImport, LiveRefinement, Assistant, PowerTools, TelemetryStrip.
- [ ] Update `apps/web-ui/TEST_PLAN.md` with scenarios & role coverage.
- [ ] Document new endpoints + usage in docs (likely `docs/how-to-guides` + README updates).

---

## Stage 8 – UX polish, accessibility, and test hardening

- [ ] `pnpm run lint`, `pnpm run build`, Playwright suite pass.
- [ ] Manual verification: ingestion workflow, run monitoring, approvals persistence, assistant tool execution.
- [ ] Write implementation summary (diff overview, outstanding risks).
- [ ] Update roadmap / DESIGN_REVIEW checklist items toggled to ✅.
