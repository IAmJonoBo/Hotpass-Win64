name: zap-baseline

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  zap:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ vars.ZAP_BASELINE_TARGET || 'http://127.0.0.1:8501' }}
      UV_EXTRAS: ${{ vars.ZAP_BASELINE_UV_EXTRAS || 'dev dashboards' }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Set up uv and Python
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          python-version: "3.13"

      - name: Install dependencies
        env:
          HOTPASS_UV_EXTRAS: ${{ env.UV_EXTRAS }}
        run: |
          set -euo pipefail
          bash ops/uv_sync_extras.sh

      - name: Launch Streamlit (if local)
        if: env.TARGET_URL == 'http://127.0.0.1:8501'
        run: |
          nohup uv run streamlit run apps/data-platform/hotpass/dashboard.py --server.headless true --server.port 8501 &
          sleep 15

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: fs
          format: sarif
          output: trivy-vulnerabilities.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@de8ad967d3548d44ef623df22cf95c3b0baf8b25 # v0.15.0
        with:
          target: ${{ env.TARGET_URL }}
          fail_action: false

      - name: Upload ZAP report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: zap-report
          path: zap_report.html

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@0499de31b99561a6d14a36a5f662c2a54f91beee # v4
        with:
          sarif_file: trivy-vulnerabilities.sarif
