# Canonical security and supply chain scan
name: 'Security: Pip-audit, Bandit & Gitleaks'

on:
  pull_request:
  name: "Security: Pip-audit, Bandit & Gitleaks"

  on:
    pull_request:
    push:
      branches: [main]
    schedule:
      - cron: '0 4 * * *'
    workflow_dispatch:

  permissions:
    contents: read
    security-events: write
    pull-requests: read

  jobs:
    security-scan:
      name: 'Quick: pip-audit + bandit'
      runs-on: ubuntu-latest
      timeout-minutes: 30
      steps:
        - uses: actions/checkout@v5
          with:
            fetch-depth: 0

        - name: Set up uv Python
          uses: astral-sh/setup-uv@v7
          with:
            python-version: '3.13'

        - name: Sync dev extras
          env:
            HOTPASS_UV_EXTRAS: dev
          run: bash ops/uv_sync_extras.sh

        - name: Run pip-audit (fast)
          run: |
            mkdir -p dist/security
            uv run pip-audit --json -o dist/security/pip-audit.json || true

        - name: Run bandit (fast)
          run: |
            mkdir -p dist/security
            uv run bandit -r apps/data-platform ops -f json -o dist/security/bandit.json || true

        - name: Upload security artefacts
          uses: actions/upload-artifact@v5
          with:
            name: security-scan
            path: |
              dist/security/pip-audit.json
              dist/security/bandit.json

    security-suite:
      name: 'Full Security Suite: Gitleaks + pip-audit + bandit'
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v5
          with:
            fetch-depth: 0

        - name: Gitleaks
          uses: gitleaks/gitleaks-action@v2
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            config-path: .gitleaks.toml
            additional-args: '--verbose'

        - name: Set up uv and Python
          uses: astral-sh/setup-uv@v7
          with:
            python-version: '3.13'

        - name: Synchronise dependencies
          env:
            HOTPASS_UV_EXTRAS: 'dev'
          run: bash ops/uv_sync_extras.sh

        - name: Run pip-audit (full)
          run: |
            mkdir -p dist/security
            uv run pip-audit --json -o dist/security/pip-audit.json || true

        - name: Run bandit (full)
          run: |
            mkdir -p dist/security
            uv run bandit -r apps/data-platform ops -f json -o dist/security/bandit.json || true

        - name: Upload security suite artefacts
          uses: actions/upload-artifact@v5
          with:
            name: security-suite
            path: |
              dist/security/pip-audit.json
              dist/security/bandit.json
        env:
