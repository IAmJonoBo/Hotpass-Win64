name: ARC runner smoke test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

permissions:
  id-token: write
  contents: read

jobs:
  lifecycle-check:
    name: Verify ARC runner lifecycle
    runs-on:
      - self-hosted
      - hotpass-arc
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Configure AWS credentials for ARC runner
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.ARC_RUNNER_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Validate AWS region configuration
        env:
          AWS_REGION_VALUE: ${{ vars.AWS_REGION }}
        run: |
          if [ -z "${AWS_REGION_VALUE}" ]; then
            echo "::error::Define the AWS_REGION repository variable before running this workflow."
            exit 1
          fi

      - name: Install dependencies
        run: |
          python -m pip install -U uv
          uv venv
          uv sync --extra orchestration --extra platform

      - name: Verify runner lifecycle
        env:
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name || github.repository }}
          AWS_REGION_VALUE: ${{ vars.AWS_REGION }}
        run: |
          OWNER=${GITHUB_OWNER}
          REPO=${GITHUB_REPOSITORY_NAME#*/}
          REGION=${AWS_REGION_VALUE}
          uv run python ops/arc/verify_runner_lifecycle.py \
            --owner "${OWNER}" \
            --repository "${OWNER}/${REPO}" \
            --scale-set hotpass-arc \
            --namespace arc-runners \
            --timeout 300 \
            --verify-oidc \
            --aws-region "${REGION}" \
            --output text
